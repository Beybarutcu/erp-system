// ============================================
// UPDATED PRISMA SCHEMA - ERP SYSTEM V2
// Tüm yeni özellikler dahil
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

model User {
  id                String   @id @default(uuid())
  username          String   @unique
  email             String   @unique
  passwordHash      String   @map("password_hash")
  fullName          String?  @map("full_name")
  role              UserRole
  languagePreference String  @default("tr") @map("language_preference")
  workshopId        String?  @map("workshop_id") // Hangi atölyede çalışıyor
  isActive          Boolean  @default(true) @map("is_active")
  lastLogin         DateTime? @map("last_login")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  workshop          Workshop? @relation(fields: [workshopId], references: [id])
  createdProducts   Product[] @relation("CreatedBy")
  createdWorkOrders WorkOrder[] @relation("CreatedBy")
  createdOrders     Order[] @relation("CreatedBy")
  inventoryTransactions InventoryTransaction[]
  auditLogs         AuditLog[]
  notifications     Notification[]
  workOrderOperations WorkOrderOperation[]
  stockRevisions    StockRevision[] @relation("RevisedBy")
  stockRevisionApprovals StockRevision[] @relation("ApprovedBy")
  qualityMeasurements QualityMeasurement[]
  finalInspections  FinalInspection[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
  VIEWER
  QUALITY_CONTROL
  WAREHOUSE
}

model Permission {
  id     String @id @default(uuid())
  role   UserRole
  module String
  action String

  @@unique([role, module, action])
  @@map("permissions")
}

// ============================================
// WORKSHOP (ATÖLYE)
// ============================================

model Workshop {
  id          String    @id @default(uuid())
  code        String    @unique
  name        String
  type        String    // INJECTION, ASSEMBLY, PAINTING, PACKAGING, QUALITY_CONTROL
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  users       User[]
  workOrders  WorkOrder[]

  @@map("workshops")
}

// ============================================
// PRODUCTS & BOM
// ============================================

model Product {
  id            String      @id @default(uuid())
  code          String      @unique
  type          ProductType
  isStocked     Boolean     @default(true) @map("is_stocked")
  isActive      Boolean     @default(true) @map("is_active")
  minStockLevel Decimal?    @db.Decimal(10, 3) @map("min_stock_level")
  maxStockLevel Decimal?    @db.Decimal(10, 3) @map("max_stock_level")
  allowNegativeStock Boolean @default(false) @map("allow_negative_stock")
  negativeStockLimit Decimal? @db.Decimal(10, 3) @map("negative_stock_limit")
  moldId        String?     @map("mold_id") // Hangi kalıpla üretiliyor
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  createdBy     String?     @map("created_by")

  // Relations
  creator           User? @relation("CreatedBy", fields: [createdBy], references: [id])
  mold              Mold? @relation(fields: [moldId], references: [id])
  translations      ProductTranslation[]
  bomParent         BomItem[] @relation("ParentProduct")
  bomChild          BomItem[] @relation("ChildProduct")
  inventoryLots     InventoryLot[]
  workOrders        WorkOrder[]
  orderItems        OrderItem[]
  outsourcingJobs   OutsourcingJob[]
  purchaseOrderItems PurchaseOrderItem[]

  @@map("products")
}

enum ProductType {
  RAW_MATERIAL
  SEMI_FINISHED
  FINISHED
  MOLD
  OUTSOURCED
  PACKAGING
}

model ProductTranslation {
  id              String  @id @default(uuid())
  productId       String  @map("product_id")
  languageCode    String  @map("language_code")
  name            String
  description     String?
  technicalSpecs  Json?   @map("technical_specs")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, languageCode])
  @@map("product_translations")
}

model BomItem {
  id            String   @id @default(uuid())
  parentId      String   @map("parent_id")
  childId       String   @map("child_id")
  quantity      Decimal  @db.Decimal(10, 4)
  unit          String   @default("PCS")
  scrapRate     Decimal? @db.Decimal(5, 2) @map("scrap_rate")
  sequence      Int      @default(0)
  notes         String?
  effectiveDate DateTime? @map("effective_date") @db.Date // Hangi tarihten itibaren geçerli
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  parent Product @relation("ParentProduct", fields: [parentId], references: [id])
  child  Product @relation("ChildProduct", fields: [childId], references: [id])

  @@unique([parentId, childId, effectiveDate])
  @@map("bom_items")
}

// ============================================
// WAREHOUSE & LOCATION (YENİ)
// ============================================

model Warehouse {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  address   String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  zones     WarehouseZone[]
  locations WarehouseLocation[]

  @@map("warehouses")
}

model WarehouseZone {
  id          String   @id @default(uuid())
  warehouseId String   @map("warehouse_id")
  code        String   // A, B, C
  name        String
  isActive    Boolean  @default(true) @map("is_active")

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  locations WarehouseLocation[]

  @@unique([warehouseId, code])
  @@map("warehouse_zones")
}

model WarehouseLocation {
  id               String   @id @default(uuid())
  warehouseId      String   @map("warehouse_id")
  zoneId           String?  @map("zone_id")
  code             String   // A1-R1-01
  fullCode         String   @map("full_code") // ANA-A-A1-R1-01
  locationType     String   @map("location_type") // PALLET, SHELF, FLOOR, RACK
  capacity         Decimal? @db.Decimal(10, 3)
  currentOccupancy Decimal  @default(0) @db.Decimal(10, 3) @map("current_occupancy")
  isActive         Boolean  @default(true) @map("is_active")

  // Relations
  warehouse        Warehouse @relation(fields: [warehouseId], references: [id])
  zone             WarehouseZone? @relation(fields: [zoneId], references: [id])
  inventoryLots    InventoryLot[]
  transfersFrom    LocationTransfer[] @relation("FromLocation")
  transfersTo      LocationTransfer[] @relation("ToLocation")
  molds            Mold[]

  @@unique([warehouseId, fullCode])
  @@map("warehouse_locations")
}

model LocationTransfer {
  id             String   @id @default(uuid())
  lotId          String   @map("lot_id")
  fromLocationId String?  @map("from_location_id")
  toLocationId   String   @map("to_location_id")
  quantity       Decimal  @db.Decimal(10, 3)
  transferDate   DateTime @default(now()) @map("transfer_date")
  reason         String?
  userId         String   @map("user_id")

  // Relations
  lot          InventoryLot @relation(fields: [lotId], references: [id])
  fromLocation WarehouseLocation? @relation("FromLocation", fields: [fromLocationId], references: [id])
  toLocation   WarehouseLocation @relation("ToLocation", fields: [toLocationId], references: [id])

  @@map("location_transfers")
}

// ============================================
// INVENTORY & FIFO
// ============================================

model InventoryLot {
  id               String              @id @default(uuid())
  lotNumber        String              @unique @map("lot_number")
  productId        String              @map("product_id")
  quantity         Decimal             @db.Decimal(10, 3)
  unitCost         Decimal?            @db.Decimal(10, 4) @map("unit_cost")
  currency         String              @default("TRY")
  supplierId       String?             @map("supplier_id")
  locationId       String?             @map("location_id") // YENİ: Hangi lokasyonda
  moldId           String?             @map("mold_id")     // YENİ: Hangi kalıpla üretildi
  receivedDate     DateTime            @db.Date @map("received_date")
  expiryDate       DateTime?           @db.Date @map("expiry_date")
  status           InventoryLotStatus  @default(AVAILABLE) // YENİ
  qualityStatus    String?             @map("quality_status") // APPROVED, QUARANTINE, REJECTED
  workOrderId      String?             @map("work_order_id")
  purchaseOrderId  String?             @map("purchase_order_id")
  batchNumber      String?             @map("batch_number")
  notes            String?
  createdAt        DateTime            @default(now()) @map("created_at")

  // Relations
  product       Product @relation(fields: [productId], references: [id])
  supplier      Supplier? @relation(fields: [supplierId], references: [id])
  location      WarehouseLocation? @relation(fields: [locationId], references: [id])
  mold          Mold? @relation(fields: [moldId], references: [id])
  workOrder     WorkOrder? @relation(fields: [workOrderId], references: [id])
  purchaseOrder PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  transactions  InventoryTransaction[]
  allocations   LotAllocation[]
  shipmentItems ShipmentItem[]
  locationTransfers LocationTransfer[]
  finalInspections FinalInspection[]

  @@index([productId, receivedDate])
  @@map("inventory_lots")
}

enum InventoryLotStatus {
  AVAILABLE
  RESERVED
  IN_PRODUCTION
  QUARANTINE
  USED
  SCRAPPED
}

model InventoryTransaction {
  id            String   @id @default(uuid())
  lotId         String   @map("lot_id")
  type          String   // IN, OUT, ADJUSTMENT, TRANSFER, SCRAP
  quantity      Decimal  @db.Decimal(10, 3)
  beforeQuantity Decimal @db.Decimal(10, 3) @map("before_quantity")
  afterQuantity  Decimal @db.Decimal(10, 3) @map("after_quantity")
  workOrderId   String?  @map("work_order_id")
  orderId       String?  @map("order_id")
  userId        String   @map("user_id")
  reason        String?
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")

  lot       InventoryLot @relation(fields: [lotId], references: [id])
  workOrder WorkOrder? @relation(fields: [workOrderId], references: [id])
  order     Order? @relation(fields: [orderId], references: [id])
  user      User @relation(fields: [userId], references: [id])

  @@index([lotId, createdAt])
  @@map("inventory_transactions")
}

model LotAllocation {
  id            String   @id @default(uuid())
  lotId         String   @map("lot_id")
  workOrderId   String   @map("work_order_id")
  allocatedQty  Decimal  @db.Decimal(10, 3) @map("allocated_qty")
  consumedQty   Decimal  @default(0) @db.Decimal(10, 3) @map("consumed_qty")
  allocationDate DateTime @default(now()) @map("allocation_date")

  lot       InventoryLot @relation(fields: [lotId], references: [id])
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id])

  @@map("lot_allocations")
}

// ============================================
// STOCK REVISION (YENİ)
// ============================================

model StockRevision {
  id              String   @id @default(uuid())
  revisionNumber  String   @unique @map("revision_number")
  productId       String   @map("product_id")
  lotId           String?  @map("lot_id")
  revisionDate    DateTime @db.Date @map("revision_date")
  systemQuantity  Decimal  @db.Decimal(10, 3) @map("system_quantity")
  countedQuantity Decimal  @db.Decimal(10, 3) @map("counted_quantity")
  difference      Decimal  @db.Decimal(10, 3)
  reason          String   // PERIODIC_COUNT, WASTE, LOSS, DAMAGE, CORRECTION
  notes           String?
  revisedBy       String   @map("revised_by")
  approvedBy      String?  @map("approved_by")
  approvalDate    DateTime? @map("approval_date")
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  reviser  User @relation("RevisedBy", fields: [revisedBy], references: [id])
  approver User? @relation("ApprovedBy", fields: [approvedBy], references: [id])

  @@map("stock_revisions")
}

// ============================================
// MOLD TRACKING (YENİ)
// ============================================

model Mold {
  id                  String   @id @default(uuid())
  code                String   @unique
  name                String
  cavityCount         Int      @map("cavity_count")
  cycleTimeSeconds    Int?     @map("cycle_time_seconds")
  ownership           String   // OWN, CUSTOMER
  status              MoldStatus @default(ACTIVE)
  locationId          String?  @map("location_id")
  totalShots          Int      @default(0) @map("total_shots")
  lastMaintenanceDate DateTime? @db.Date @map("last_maintenance_date")
  lastMaintenanceShots Int?    @map("last_maintenance_shots")
  nextMaintenanceShots Int?    @map("next_maintenance_shots")
  maintenanceIntervalShots Int? @map("maintenance_interval_shots")
  acquisitionDate     DateTime? @db.Date @map("acquisition_date")
  cost                Decimal? @db.Decimal(12, 2)
  notes               String?
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")

  // Relations
  location     WarehouseLocation? @relation(fields: [locationId], references: [id])
  products     Product[]
  maintenance  MoldMaintenance[]
  usage        MoldUsage[]
  inventoryLots InventoryLot[]

  @@map("molds")
}

enum MoldStatus {
  ACTIVE
  MAINTENANCE
  BROKEN
  SCRAPPED
  INACTIVE
}

model MoldMaintenance {
  id                    String   @id @default(uuid())
  moldId                String   @map("mold_id")
  maintenanceDate       DateTime @db.Date @map("maintenance_date")
  maintenanceType       String   @map("maintenance_type") // PREVENTIVE, CORRECTIVE, CLEANING
  shotCountAtMaintenance Int     @map("shot_count_at_maintenance")
  description           String?
  cost                  Decimal? @db.Decimal(10, 2)
  performedBy           String?  @map("performed_by")
  notes                 String?
  createdAt             DateTime @default(now()) @map("created_at")

  // Relations
  mold Mold @relation(fields: [moldId], references: [id])

  @@map("mold_maintenance")
}

model MoldUsage {
  id             String   @id @default(uuid())
  moldId         String   @map("mold_id")
  workOrderId    String   @map("work_order_id")
  startDate      DateTime @map("start_date")
  endDate        DateTime? @map("end_date")
  shotsProduced  Int      @map("shots_produced")
  defectCount    Int      @default(0) @map("defect_count")
  notes          String?

  // Relations
  mold      Mold @relation(fields: [moldId], references: [id])
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id])

  @@map("mold_usage")
}

// ============================================
// WORK ORDERS
// ============================================

model WorkOrder {
  id                 String          @id @default(uuid())
  woNumber           String          @unique @map("wo_number")
  productId          String          @map("product_id")
  orderId            String?         @map("order_id")
  workshopId         String?         @map("workshop_id") // YENİ: Hangi atölyede
  plannedQuantity    Decimal         @db.Decimal(10, 3) @map("planned_quantity")
  producedQuantity   Decimal         @default(0) @db.Decimal(10, 3) @map("produced_quantity")
  scrapQuantity      Decimal         @default(0) @db.Decimal(10, 3) @map("scrap_quantity")
  status             WorkOrderStatus @default(PLANNED)
  priority           String          @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  machineId          String?         @map("machine_id")
  supplierId         String?         @map("supplier_id") // Fason için
  plannedStartDate   DateTime?       @db.Date @map("planned_start_date")
  plannedEndDate     DateTime?       @db.Date @map("planned_end_date")
  actualStartDate    DateTime?       @map("actual_start_date")
  actualEndDate      DateTime?       @map("actual_end_date")
  estimatedDuration  Int?            @map("estimated_duration")
  allowBomChanges    Boolean         @default(true) @map("allow_bom_changes") // YENİ
  partialCloseReason String?         @map("partial_close_reason") // YENİ
  partialCloseDate   DateTime?       @map("partial_close_date")   // YENİ
  notes              String?
  createdAt          DateTime        @default(now()) @map("created_at")
  createdBy          String?         @map("created_by")

  // Relations
  product       Product @relation(fields: [productId], references: [id])
  order         Order? @relation(fields: [orderId], references: [id])
  workshop      Workshop? @relation(fields: [workshopId], references: [id])
  machine       Machine? @relation(fields: [machineId], references: [id])
  supplier      Supplier? @relation(fields: [supplierId], references: [id])
  creator       User? @relation("CreatedBy", fields: [createdBy], references: [id])
  materials     WorkOrderMaterial[]
  operations    WorkOrderOperation[]
  inventoryLots InventoryLot[]
  transactions  InventoryTransaction[]
  allocations   LotAllocation[]
  moldUsage     MoldUsage[]
  qualityMeasurements QualityMeasurement[]
  finalInspections FinalInspection[]

  @@index([status, plannedStartDate])
  @@map("work_orders")
}

enum WorkOrderStatus {
  PLANNED
  RELEASED
  IN_PROGRESS
  PAUSED
  COMPLETED
  PARTIALLY_COMPLETED
  CANCELLED
}

model WorkOrderMaterial {
  id              String   @id @default(uuid())
  workOrderId     String   @map("work_order_id")
  productId       String   @map("product_id")
  plannedQuantity Decimal  @db.Decimal(10, 3) @map("planned_quantity")
  issuedQuantity  Decimal  @default(0) @db.Decimal(10, 3) @map("issued_quantity")
  consumedQuantity Decimal @default(0) @db.Decimal(10, 3) @map("consumed_quantity")
  unit            String   @default("PCS")

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@map("work_order_materials")
}

model WorkOrderOperation {
  id           String   @id @default(uuid())
  workOrderId  String   @map("work_order_id")
  operationType String  @map("operation_type") // START, PAUSE, RESUME, COMPLETE, PRODUCTION_RECORD
  quantity     Decimal? @db.Decimal(10, 3)
  operatorId   String   @map("operator_id")
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  operator  User @relation(fields: [operatorId], references: [id])

  @@map("work_order_operations")
}

// ============================================
// QUALITY CONTROL (YENİ)
// ============================================

model QualityMeasurement {
  id                String   @id @default(uuid())
  workOrderId       String   @map("work_order_id")
  measurementTime   DateTime @default(now()) @map("measurement_time")
  measuredBy        String   @map("measured_by")
  sampleSize        Int      @map("sample_size")
  parametersJson    Json     @map("parameters_json") // {length: {value, min, max, pass}, weight: {...}}
  overallResult     String   // PASS, FAIL, CONDITIONAL
  defectCount       Int      @default(0) @map("defect_count")
  defectTypes       String?  @map("defect_types") // JSON array
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id])
  measurer  User @relation(fields: [measuredBy], references: [id])
  defects   QualityDefect[]

  @@map("quality_measurements")
}

model FinalInspection {
  id                   String   @id @default(uuid())
  lotId                String   @map("lot_id")
  workOrderId          String?  @map("work_order_id")
  inspectionDate       DateTime @default(now()) @map("inspection_date")
  inspectedBy          String   @map("inspected_by")
  totalQuantity        Decimal  @db.Decimal(10, 3) @map("total_quantity")
  acceptedQuantity     Decimal  @db.Decimal(10, 3) @map("accepted_quantity")
  rejectedQuantity     Decimal  @db.Decimal(10, 3) @map("rejected_quantity")
  measurementsJson     Json?    @map("measurements_json")
  visualInspectionPass Boolean  @map("visual_inspection_pass")
  functionalTestPass   Boolean  @map("functional_test_pass")
  overallResult        String   // APPROVED, REJECTED, CONDITIONAL
  photos               String[] @default([])
  notes                String?

  // Relations
  lot         InventoryLot @relation(fields: [lotId], references: [id])
  workOrder   WorkOrder? @relation(fields: [workOrderId], references: [id])
  inspector   User @relation(fields: [inspectedBy], references: [id])
  defects     QualityDefect[]

  @@map("final_inspections")
}

model QualityDefect {
  id                   String   @id @default(uuid())
  measurementId        String?  @map("measurement_id")
  inspectionId         String?  @map("inspection_id")
  defectType           String   @map("defect_type") // SCRATCH, DISCOLORATION, DIMENSION, CRACK, etc.
  severity             String   // MINOR, MAJOR, CRITICAL
  quantity             Int
  description          String?
  photo                String?
  createdAt            DateTime @default(now()) @map("created_at")

  // Relations
  measurement QualityMeasurement? @relation(fields: [measurementId], references: [id])
  inspection  FinalInspection? @relation(fields: [inspectionId], references: [id])

  @@map("quality_defects")
}

// ============================================
// MACHINES & CAPACITY
// ============================================

model Machine {
  id               String   @id @default(uuid())
  code             String   @unique
  machineType      String   @map("machine_type")
  capacityPerHour  Decimal? @db.Decimal(10, 2) @map("capacity_per_hour")
  status           MachineStatus @default(ACTIVE)
  location         String?
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  translations     MachineTranslation[]
  shifts           MachineShift[]
  maintenance      MachineMaintenance[]
  workOrders       WorkOrder[]

  @@map("machines")
}

enum MachineStatus {
  ACTIVE
  MAINTENANCE
  BROKEN
  INACTIVE
}

model MachineTranslation {
  id           String @id @default(uuid())
  machineId    String @map("machine_id")
  languageCode String @map("language_code")
  name         String
  description  String?

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@unique([machineId, languageCode])
  @@map("machine_translations")
}

model MachineShift {
  id         String   @id @default(uuid())
  machineId  String   @map("machine_id")
  dayOfWeek  Int      @map("day_of_week")
  shiftName  String   @map("shift_name")
  startTime  DateTime @map("start_time") @db.Time
  endTime    DateTime @map("end_time") @db.Time
  isActive   Boolean  @default(true) @map("is_active")

  machine Machine @relation(fields: [machineId], references: [id])

  @@map("machine_shifts")
}

model MachineMaintenance {
  id              String   @id @default(uuid())
  machineId       String   @map("machine_id")
  maintenanceType String   @map("maintenance_type")
  scheduledDate   DateTime @map("scheduled_date") @db.Date
  completedDate   DateTime? @map("completed_date") @db.Date
  durationHours   Int?     @map("duration_hours")
  status          String   @default("PLANNED")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")

  machine Machine @relation(fields: [machineId], references: [id])

  @@map("machine_maintenance")
}

// ============================================
// PERSONNEL & CAPACITY (YENİ)
// ============================================

model Personnel {
  id            String   @id @default(uuid())
  code          String   @unique
  name          String
  position      String   // OPERATOR, SUPERVISOR, QUALITY_CONTROL
  shift         String   // DAY, NIGHT, ROTATING
  weeklyHours   Int      @map("weekly_hours")
  skills        Json?    // {machines: ["MACH-01", "MACH-02"], operations: ["ASSEMBLY"]}
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  capacities PersonnelCapacity[]

  @@map("personnel")
}

model PersonnelCapacity {
  id            String   @id @default(uuid())
  personnelId   String   @map("personnel_id")
  weekNumber    Int      @map("week_number")
  year          Int
  plannedHours  Decimal  @db.Decimal(5, 2) @map("planned_hours")
  actualHours   Decimal  @default(0) @db.Decimal(5, 2) @map("actual_hours")
  overtimeHours Decimal  @default(0) @db.Decimal(5, 2) @map("overtime_hours")

  // Relations
  personnel Personnel @relation(fields: [personnelId], references: [id])

  @@unique([personnelId, year, weekNumber])
  @@map("personnel_capacity")
}

// ============================================
// PURCHASE ORDERS (YENİ)
// ============================================

model PurchaseOrder {
  id                   String   @id @default(uuid())
  orderNumber          String   @unique @map("order_number")
  supplierId           String   @map("supplier_id")
  orderDate            DateTime @db.Date @map("order_date")
  expectedDeliveryDate DateTime? @db.Date @map("expected_delivery_date")
  status               PurchaseOrderStatus @default(PENDING)
  totalAmount          Decimal? @db.Decimal(12, 2) @map("total_amount")
  currency             String   @default("TRY")
  paymentTerms         String?  @map("payment_terms")
  notes                String?
  createdAt            DateTime @default(now()) @map("created_at")

  // Relations
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  items         PurchaseOrderItem[]
  confirmations PurchaseOrderConfirmation[]
  inventoryLots InventoryLot[]

  @@map("purchase_orders")
}

enum PurchaseOrderStatus {
  PENDING
  CONFIRMED
  PARTIAL
  COMPLETED
  CANCELLED
}

model PurchaseOrderItem {
  id               String   @id @default(uuid())
  purchaseOrderId  String   @map("purchase_order_id")
  productId        String   @map("product_id")
  quantity         Decimal  @db.Decimal(10, 3)
  unitPrice        Decimal? @db.Decimal(10, 4) @map("unit_price")
  receivedQuantity Decimal  @default(0) @db.Decimal(10, 3) @map("received_quantity")
  receivedDate     DateTime? @db.Date @map("received_date")
  notes            String?

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product @relation(fields: [productId], references: [id])

  @@map("purchase_order_items")
}

model PurchaseOrderConfirmation {
  id              String   @id @default(uuid())
  purchaseOrderId String   @map("purchase_order_id")
  confirmationDate DateTime @db.Date @map("confirmation_date")
  confirmedBy     String?  @map("confirmed_by")
  isRevised       Boolean  @default(false) @map("is_revised")
  revisionNotes   String?  @map("revision_notes")
  status          String   // CONFIRMED, REVISED, REJECTED
  documentUrl     String?  @map("document_url")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  @@map("purchase_order_confirmations")
}

// ============================================
// ORDERS & CUSTOMERS
// ============================================

model Order {
  id           String      @id @default(uuid())
  orderNumber  String      @unique @map("order_number")
  customerId   String      @map("customer_id")
  orderDate    DateTime    @db.Date @map("order_date")
  deliveryDate DateTime?   @db.Date @map("delivery_date")
  status       OrderStatus @default(PENDING)
  confirmationStatus String? @map("confirmation_status") // YENİ: QUOTATION, AWAITING, CONFIRMED
  totalAmount  Decimal?    @db.Decimal(12, 2) @map("total_amount")
  currency     String      @default("TRY")
  notes        String?
  createdAt    DateTime    @default(now()) @map("created_at")
  createdBy    String?     @map("created_by")

  // Relations
  customer          Customer @relation(fields: [customerId], references: [id])
  creator           User? @relation("CreatedBy", fields: [createdBy], references: [id])
  items             OrderItem[]
  workOrders        WorkOrder[]
  shipments         Shipment[]
  confirmations     OrderConfirmation[]
  statusHistory     OrderStatusHistory[]
  inventoryTransactions InventoryTransaction[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  IN_PRODUCTION
  READY
  SHIPPED
  COMPLETED
  CANCELLED
}

model OrderItem {
  id                String  @id @default(uuid())
  orderId           String  @map("order_id")
  productId         String  @map("product_id")
  quantity          Decimal @db.Decimal(10, 3)
  unitPrice         Decimal? @db.Decimal(10, 4) @map("unit_price")
  deliveredQuantity Decimal @default(0) @db.Decimal(10, 3) @map("delivered_quantity")
  notes             String?

  // Relations
  order         Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product @relation(fields: [productId], references: [id])
  shipmentItems ShipmentItem[]

  @@map("order_items")
}

model OrderConfirmation {
  id                      String   @id @default(uuid())
  orderId                 String   @map("order_id")
  quotationSentDate       DateTime? @db.Date @map("quotation_sent_date")
  quotationNumber         String?  @map("quotation_number")
  customerConfirmationDate DateTime? @db.Date @map("customer_confirmation_date")
  confirmedBy             String?  @map("confirmed_by")
  status                  String   @default("QUOTATION") // QUOTATION, AWAITING, CONFIRMED, CANCELLED
  documentUrl             String?  @map("document_url")
  notes                   String?
  createdAt               DateTime @default(now()) @map("created_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id])

  @@map("order_confirmations")
}

model OrderStatusHistory {
  id           String   @id @default(uuid())
  orderId      String   @map("order_id")
  previousStatus String @map("previous_status")
  newStatus    String   @map("new_status")
  changedAt    DateTime @default(now()) @map("changed_at")
  changedBy    String?  @map("changed_by")
  reason       String?

  // Relations
  order Order @relation(fields: [orderId], references: [id])

  @@map("order_status_history")
}

model Customer {
  id             String   @id @default(uuid())
  code           String   @unique
  name           String
  contactPerson  String?  @map("contact_person")
  email          String?
  phone          String?
  address        String?
  taxNumber      String?  @map("tax_number")
  paymentTerms   Int?     @map("payment_terms")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  orders    Order[]
  shipments Shipment[]
  sampleRequests SampleRequest[]

  @@map("customers")
}

// ============================================
// SUPPLIERS & OUTSOURCING
// ============================================

model Supplier {
  id            String       @id @default(uuid())
  code          String       @unique
  name          String
  type          SupplierType
  contactPerson String?      @map("contact_person")
  email         String?
  phone         String?
  address       String?
  taxNumber     String?      @map("tax_number")
  leadTimeDays  Int?         @map("lead_time_days")
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")

  // Relations
  inventoryLots     InventoryLot[]
  workOrders        WorkOrder[]
  outsourcingJobs   OutsourcingJob[]
  purchaseOrders    PurchaseOrder[]

  @@map("suppliers")
}

enum SupplierType {
  MATERIAL
  OUTSOURCING
  BOTH
}

model OutsourcingJob {
  id                 String               @id @default(uuid())
  jobNumber          String               @unique @map("job_number")
  workOrderId        String?              @map("work_order_id")
  supplierId         String               @map("supplier_id")
  productId          String               @map("product_id")
  processType        String               @map("process_type") // PAINTING, ASSEMBLY, MACHINING
  sentQuantity       Decimal              @db.Decimal(10, 3) @map("sent_quantity")
  receivedQuantity   Decimal              @default(0) @db.Decimal(10, 3) @map("received_quantity")
  sentDate           DateTime?            @db.Date @map("sent_date")
  expectedReturnDate DateTime?            @db.Date @map("expected_return_date")
  actualReturnDate   DateTime?            @db.Date @map("actual_return_date")
  cost               Decimal?             @db.Decimal(10, 2)
  status             OutsourcingStatus    @default(PENDING)
  notes              String?
  createdAt          DateTime             @default(now()) @map("created_at")

  // Relations
  supplier  Supplier @relation(fields: [supplierId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  @@map("outsourcing_jobs")
}

enum OutsourcingStatus {
  PENDING
  SENT
  IN_PROCESS
  PARTIAL_RETURN
  RETURNED
  CANCELLED
}

// ============================================
// SHIPPING
// ============================================

model Shipment {
  id             String         @id @default(uuid())
  shipmentNumber String         @unique @map("shipment_number")
  orderId        String?        @map("order_id")
  customerId     String         @map("customer_id")
  shipmentDate   DateTime       @db.Date @map("shipment_date")
  deliveredDate  DateTime?      @db.Date @map("delivered_date")
  carrier        String?
  trackingNumber String?        @map("tracking_number")
  status         ShipmentStatus @default(PENDING)
  notes          String?
  createdAt      DateTime       @default(now()) @map("created_at")
  createdBy      String?        @map("created_by")

  // Relations
  order    Order?   @relation(fields: [orderId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  items    ShipmentItem[]

  @@map("shipments")
}

enum ShipmentStatus {
  PENDING
  PREPARED
  SHIPPED
  DELIVERED
  CANCELLED
}

model ShipmentItem {
  id          String  @id @default(uuid())
  shipmentId  String  @map("shipment_id")
  orderItemId String? @map("order_item_id")
  lotId       String  @map("lot_id")
  quantity    Decimal @db.Decimal(10, 3)

  // Relations
  shipment  Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  orderItem OrderItem? @relation(fields: [orderItemId], references: [id])
  lot       InventoryLot @relation(fields: [lotId], references: [id])

  @@map("shipment_items")
}

// ============================================
// SAMPLE & PROTOTYPE TRACKING (YENİ)
// ============================================

model SampleRequest {
  id                String   @id @default(uuid())
  requestNumber     String   @unique @map("request_number")
  customerId        String   @map("customer_id")
  productId         String?  @map("product_id")
  requestDate       DateTime @db.Date @map("request_date")
  requestedQuantity Decimal  @db.Decimal(10, 3) @map("requested_quantity")
  deadline          DateTime? @db.Date
  technicalDrawing  String?  @map("technical_drawing")
  status            SampleStatus @default(PENDING)
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  customer    Customer @relation(fields: [customerId], references: [id])
  productions SampleProduction[]
  approvals   SampleApproval[]

  @@map("sample_requests")
}

enum SampleStatus {
  PENDING
  IN_PRODUCTION
  SENT
  APPROVED
  REJECTED
  REVISION
  CANCELLED
}

model SampleProduction {
  id              String   @id @default(uuid())
  sampleRequestId String   @map("sample_request_id")
  workOrderId     String?  @map("work_order_id")
  productionDate  DateTime @db.Date @map("production_date")
  producedQuantity Decimal @db.Decimal(10, 3) @map("produced_quantity")
  photos          String[] @default([])
  notes           String?

  // Relations
  sampleRequest SampleRequest @relation(fields: [sampleRequestId], references: [id])

  @@map("sample_productions")
}

model SampleApproval {
  id               String   @id @default(uuid())
  sampleRequestId  String   @map("sample_request_id")
  approvalDate     DateTime @db.Date @map("approval_date")
  approvalStatus   String   // APPROVED, REVISION, REJECTED
  customerFeedback String?  @map("customer_feedback")
  revisionNotes    String?  @map("revision_notes")
  documentUrl      String?  @map("document_url")

  // Relations
  sampleRequest SampleRequest @relation(fields: [sampleRequestId], references: [id])

  @@map("sample_approvals")
}

// ============================================
// REPORTING & AUTOMATION (YENİ)
// ============================================

model ReportSchedule {
  id              String   @id @default(uuid())
  reportType      String   @map("report_type") // WEEKLY_SUMMARY, STOCK_ALERT, PRODUCTION_SUMMARY
  schedule        String   // CRON expression: "0 9 * * 1" (Every Monday 9 AM)
  recipients      String[] // Email addresses
  parameters      Json?    // Report-specific parameters
  isActive        Boolean  @default(true) @map("is_active")
  lastRun         DateTime? @map("last_run")
  nextRun         DateTime? @map("next_run")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  exports ReportExport[]

  @@map("report_schedules")
}

model ReportExport {
  id          String   @id @default(uuid())
  scheduleId  String?  @map("schedule_id")
  reportType  String   @map("report_type")
  format      String   @default("XLSX") // XLSX, PDF, CSV
  fileUrl     String   @map("file_url")
  parameters  Json?
  generatedAt DateTime @default(now()) @map("generated_at")
  generatedBy String?  @map("generated_by")

  // Relations
  schedule ReportSchedule? @relation(fields: [scheduleId], references: [id])

  @@map("report_exports")
}

// ============================================
// SYSTEM SETTINGS (YENİ)
// ============================================

model SystemSettings {
  id                  String   @id @default(uuid())
  key                 String   @unique
  value               String
  dataType            String   @map("data_type") // STRING, NUMBER, BOOLEAN, JSON
  category            String   // GENERAL, INVENTORY, PRODUCTION, QUALITY
  description         String?
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// ============================================
// NOTIFICATIONS & AUDIT
// ============================================

model Notification {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  type          String
  severity      String
  messageKey    String   @map("message_key")
  messageParams Json?    @map("message_params")
  referenceType String?  @map("reference_type")
  referenceId   String?  @map("reference_id")
  isRead        Boolean  @default(false) @map("is_read")
  createdAt     DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  tableName  String   @map("table_name")
  recordId   String?  @map("record_id")
  action     String
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([tableName, recordId])
  @@map("audit_logs")
}
